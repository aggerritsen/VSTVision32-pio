#include <Arduino.h>
#include <Wire.h>
#include "VisionAI.h"

static VisionAI vision;
static VisionAIConfig cfg;
static VisionFrame frame;

static uint32_t consecutive_failures = 0;
static constexpr uint32_t REINIT_AFTER_FAILURES = 3;

void setup()
{
    Serial.begin(115200);
    delay(500);

    Serial.println("=======================================");
    Serial.println(" TEMP MAIN | VisionAI reusable helper ");
    Serial.println("=======================================");

    // Your known-good I2C pins
    cfg.sda = 3;
    cfg.scl = 8;
    cfg.i2c_hz = 400000;

    // Known behavior
    cfg.task_id = 1;
    cfg.invoke_arg2 = false;
    cfg.invoke_arg3 = false;

    // Busy/backoff
    cfg.rc_busy = 3;
    cfg.invoke_deadline_ms = 25000;

    cfg.backoff_start_ms = 30;
    cfg.backoff_reset_ms = 30;
    cfg.backoff_max_ms   = 1200;
    cfg.backoff_mult_num = 3;
    cfg.backoff_mult_den = 2;

    // Logging
    cfg.print_image_hex_preview = true;
    cfg.image_hex_preview_bytes = 64;
    cfg.post_success_idle_ms = 10;
    cfg.busy_log_every_ms = 2000;

    // Recovery
    cfg.reinit_cooldown_ms = 1500;

    if (!vision.begin(Wire, cfg))
    {
        Serial.println("❌ vision.begin failed");
        while (1) delay(100);
    }
    Serial.println("✅ vision.begin OK");

    // Optional LEDs
    vision.enableLeds(1, 2, 3, 1000);
}

void loop()
{
    vision.serviceLeds();

    if (vision.capture(frame))
    {
        consecutive_failures = 0;
        vision.printFrame(frame);
        return;
    }

    consecutive_failures++;
    Serial.printf("⚠️ capture failed (%lu/%lu)\n",
                  (unsigned long)consecutive_failures,
                  (unsigned long)REINIT_AFTER_FAILURES);

    if (consecutive_failures >= REINIT_AFTER_FAILURES)
    {
        (void)vision.reinit();
        consecutive_failures = 0;
    }

    delay(50);
}
